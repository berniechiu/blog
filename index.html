<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"berniechiu.github.io","root":"/blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="BC Blog">
<meta property="og:url" content="https://berniechiu.github.io/blog/index.html">
<meta property="og:site_name" content="BC Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Bernie Chiu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://berniechiu.github.io/blog/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>BC Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">BC Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Chase Excellence, Success will Follow</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/blog/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://berniechiu.github.io/blog/posts/cecaae96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Bernie Chiu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BC Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/posts/cecaae96/" class="post-title-link" itemprop="url">RubyConf Taiwan 2019 - Let's Scale Ruby Applications with Love</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-09-01 20:50:09" itemprop="dateCreated datePublished" datetime="2019-09-01T20:50:09+08:00">2019-09-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-08-28 01:40:07" itemprop="dateModified" datetime="2021-08-28T01:40:07+08:00">2021-08-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>We know observing performance is tedious and tiresome. But what if we continue to write codes that poison the repo and later become legacy which somehow results in software regression? Because of the situation like this, we all want the code itself to be more readable, explainable and performant by default, so others are able to benefit from reading it and leaning from the codebase.</p>
<p>By giving few real world examples on how we optimize large scaled apps in practice, I hope it will help programmers to clearly understand the step by step procedure to think of their codes with more conventional ways of approaching modern software principles. Bringing the happiness to yourself, and also to others</p>
<script async class="speakerdeck-embed" data-id="656cb9fbffb64d348f46898b9eb93371" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>

<hr>
<iframe width="560" height="315" src="https://www.youtube.com/embed/O1zTYLWpmw4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://berniechiu.github.io/blog/posts/1db0a039/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Bernie Chiu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BC Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/posts/1db0a039/" class="post-title-link" itemprop="url">First Step of Creating a Well-Rounded CI/CD Flow</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-08 22:37:26" itemprop="dateCreated datePublished" datetime="2018-10-08T22:37:26+08:00">2018-10-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-10-14 12:02:22" itemprop="dateModified" datetime="2018-10-14T12:02:22+08:00">2018-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/blog/images/bonio-ci-cd-flow-chart.png" alt="PaGamO CI/CD Flow Chart"></p>
<p>Long time ago, I joined my previous company <a target="_blank" rel="noopener" href="https://www.pagamo.org/">PaGamO</a> and the deployment is still raw, using <code>git clone</code> and some manual restart script specifically for the project, so I decided to give it a change.</p>
<p>The above figure is the first draft for my redesign CI/CD, also with the help of few gems like:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/AssetSync/asset_sync">Asset Sync</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/capistrano/capistrano">Capistrano</a></li>
</ul>
<p>Of course, those are common gems used in Rails community. As a Senior Software Engineer, I always seek challenges to automate as much as I could and use tools to resolve problems ahead to improve team performance.</p>
<p>Besides the tech part of introducing tools and revamped workflow, keys to achieve such agreement are always about communication between teams.</p>
<p>Like QA needs to know about tasks at what certain point of time needs to be tested, understanding the new task assignment changes without too much communication effort.</p>
<p>Because a good workflow speaks for itself, everyone should know what to do when an assignment changes and what the status of the task is meant for each member. Therefore, teams can accomplish their jobs easily. As a Scrum Lead, I should always keep track of progress but not by asking team members, but using tools and job board to quickly ship and track products automatically.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://berniechiu.github.io/blog/posts/4f0bed1f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Bernie Chiu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BC Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/posts/4f0bed1f/" class="post-title-link" itemprop="url">Refactor Legacy Controller in a Good SOLID Pattern</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-10 08:51:18" itemprop="dateCreated datePublished" datetime="2018-09-10T08:51:18+08:00">2018-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-10-14 12:02:22" itemprop="dateModified" datetime="2018-10-14T12:02:22+08:00">2018-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="The-Problem"><a href="#The-Problem" class="headerlink" title="The Problem"></a>The Problem</h3><p>Refactoring is hard, but I believe looking at the code that is hard to read is even poisonous to the team. Code smell happens all the time, and how we refactor it not only improve the readability but also provide a good sample for incoming juniors’ career development in the company.</p>
<p>Let’s looks that this piece of code:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">module</span> <span class="title">Api</span></span></span><br><span class="line">   <span class="class"><span class="keyword">module</span> <span class="title">Admin</span></span></span><br><span class="line">     <span class="class"><span class="keyword">module</span> <span class="title">Analytics</span></span></span><br><span class="line">       <span class="class"><span class="keyword">class</span> <span class="title">ProductsController</span> &lt; V1::ApiController</span></span><br><span class="line">         <span class="function"><span class="keyword">def</span> <span class="title">top_sold</span></span></span><br><span class="line">           raise ParamsMissing, <span class="string">&#x27;params missing&#x27;</span> <span class="keyword">if</span> params_missing</span><br><span class="line">           raise InvalidDateInterval, <span class="string">&#x27;range of days is not allowed&#x27;</span> <span class="keyword">unless</span> check_date_interval</span><br><span class="line">           response = perform(</span><br><span class="line">             <span class="symbol">merchant_id:</span> current_merchant.id,</span><br><span class="line">             <span class="symbol">url:</span> analytics_params[<span class="symbol">:url</span>]</span><br><span class="line">             <span class="symbol">start_date:</span> analytics_params[<span class="symbol">:start_date</span>],</span><br><span class="line">             <span class="symbol">end_date:</span> analytics_params[<span class="symbol">:end_date</span>]</span><br><span class="line">           )</span><br><span class="line"></span><br><span class="line">           render <span class="symbol">json:</span> <span class="symbol">:</span><span class="symbol">:Analytics</span><span class="symbol">:</span><span class="symbol">:FormatService</span>.top_product_format(response[<span class="string">&#x27;metrics&#x27;</span>]), <span class="symbol">status:</span> <span class="symbol">:ok</span></span><br><span class="line">         <span class="keyword">rescue</span> RestClient::Exception =&gt; ex</span><br><span class="line">           render <span class="symbol">json:</span> JSON.parse(ex.response), <span class="symbol">status:</span> <span class="symbol">:unprocessable_entity</span></span><br><span class="line">         <span class="keyword">rescue</span> =&gt; ex</span><br><span class="line">           render <span class="symbol">json:</span> &#123; <span class="symbol">message:</span> ex.message &#125;, <span class="symbol">status:</span> <span class="symbol">:unprocessable_entity</span></span><br><span class="line">         <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">         ...</span><br><span class="line">         ...</span><br><span class="line">         ...</span><br><span class="line">       <span class="keyword">end</span></span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Even the functions are separated, but let’s refresh the responsibility of the Rails <code>controller</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">It coordinates the interaction between the user, the views, and the model. The controller is also a home to a number of important ancillary services. It is responsible for routing external requests to internal actions.</span><br></pre></td></tr></table></figure>

<p>Simple and elegant. However, what we did here kind of violates the first SOLID principles which is <code>Single Responsibility</code>.</p>
<p>Look at the line <code>6</code> to <code>7</code>, basically it’s doing the job besides the controller routing but to validate errors. If we want to customize and even extend more validations, might end up all the private methods in controller and action in front of action definition.</p>
<p>Also, line <code>8</code> to <code>11</code> also comes across a request of a third party handler, even a <code>RestClient</code> or <code>HTTParty</code> request being put here looks out of place. If we want to extend more methods like <code>post</code> or <code>form</code> requests, definitely will bloat up the private functions being defined in the controller here.</p>
<p>Of course, line <code>13</code> to <code>18</code> looks out of place too. We have a decorator/serializer here but strongly depend on the single attribute of the response. And other responses seem not to fit in this decorator. What if we want to change the format when the endpoint change, this looks like a violation of <code>Open/Close Principle</code> for me.</p>
<p>Let’s refresh the definition of the <code>Open/Close Principle</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">software entities (classes, modules, functions, etc.) should be open for extension, but closed for modification</span><br></pre></td></tr></table></figure>

<h3 id="What-I-Did-Here"><a href="#What-I-Did-Here" class="headerlink" title="What I Did Here"></a>What I Did Here</h3><p>Let’s first extract the request handler to its own module</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Anaylytics</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line">    <span class="keyword">include</span> Singleton</span><br><span class="line"></span><br><span class="line">    BASE_URL = <span class="string">&quot;<span class="subst">#&#123;SERVICES[<span class="string">&#x27;anaylytics&#x27;</span>][<span class="string">&#x27;api_host&#x27;</span>]&#125;</span>&quot;</span>.freeze</span><br><span class="line">    URLS = &#123;</span><br><span class="line">      <span class="symbol">top_sale:</span> <span class="string">&#x27;top_sale&#x27;</span></span><br><span class="line">    &#125;.freeze</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> &lt;&lt; self</span></span><br><span class="line">      extend Forwardable</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">method_added</span><span class="params">(method)</span></span></span><br><span class="line">        (<span class="class"><span class="keyword">class</span> &lt;&lt; self;</span> <span class="keyword">self</span>; <span class="keyword">end</span>).def_delegator <span class="symbol">:instance</span>, method</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(key, <span class="symbol">params:</span> &#123;&#125;)</span></span></span><br><span class="line">      RestClient::Request.execute(</span><br><span class="line">        <span class="symbol">method:</span> <span class="symbol">:get</span>,</span><br><span class="line">        <span class="symbol">url:</span> <span class="string">&quot;<span class="subst">#&#123;BASE_URL&#125;</span>/<span class="subst">#&#123;URLS[key]&#125;</span>&quot;</span>,</span><br><span class="line">        <span class="symbol">headers:</span> &#123; <span class="symbol">params:</span> params &#125;</span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Looks good, right? Now the request has its own handler and we can simply define methods like <code>GET</code>, <code>POST</code> of our own and extend easily.</p>
<p>And the singleton class with <code>method_added</code> being delegated, allows us not to write <code>.instance</code> all the time but to have the property of instance like class. This is a better thread safe management and allow us to extend some <code>ActiveSupport</code> methods that are specifically for instance methods.</p>
<p>Now let’s define our <code>ErrorsHandler</code></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Anaylytics</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line">    <span class="class"><span class="keyword">module</span> <span class="title">ErrorsHandler</span></span></span><br><span class="line">      <span class="keyword">include</span> AcctiveSupport::Concern</span><br><span class="line">      <span class="keyword">include</span> ActiveSupport::Rescuable</span><br><span class="line"></span><br><span class="line">      included <span class="keyword">do</span></span><br><span class="line">        rescue_from RequestError, <span class="symbol">with:</span> <span class="symbol">:deny_access</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      protected</span><br><span class="line"></span><br><span class="line">      <span class="class"><span class="keyword">class</span> <span class="title">RequestError</span> &lt; StandardError</span></span><br><span class="line">		 ...</span><br><span class="line">		 ...</span><br><span class="line">		 ...</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      private</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">deny_access</span></span></span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Now we have customized errors and rescuer being defined in a single class. And adopt the use of few <code>ActiveSupport</code> modules to make it even cleaner like <code>rescue_from</code> allow us to define rescue function to its own method name.</p>
<p>How about <code>ParamsMissing</code> and <code>DateInvalid</code> in the original controller action? Seems not being placed here, and that’s right! The logic sounds more like a model to me and I think should deserve to have its own validator here.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Analytics</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ParamsValidator</span></span></span><br><span class="line">      <span class="keyword">include</span> ActiveModel::Validations</span><br><span class="line">      <span class="keyword">attr_accessor</span> <span class="symbol">:start_date</span>, <span class="symbol">:end_date</span></span><br><span class="line"></span><br><span class="line">      INTERVAL = <span class="number">3</span>.months.freeze</span><br><span class="line"></span><br><span class="line">      validates <span class="symbol">:start_date</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line">      validates <span class="symbol">:end_date</span>, <span class="symbol">presence:</span> <span class="literal">true</span></span><br><span class="line">      validate <span class="symbol">:belongs_to_interval</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(params = &#123;&#125;)</span></span></span><br><span class="line">        ...</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">belongs_to_interval</span></span></span><br><span class="line">        ...</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">validate!</span></span></span><br><span class="line">        raise ValidationError.new(errors.full_messages) <span class="keyword">if</span> invalid?</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="class"><span class="keyword">class</span> <span class="title">ValidationError</span> &lt; StandardError;</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>I sometimes find <code>ActiveModel::Validations</code> is very useful when we want to define something that’s not actually in current scope of Rails database model. And we can still adopt the use the simple and elegant validation solution to its own class.</p>
<p>And last we see a format service that is running wild and not unified for each response in the original action. Let’s rename it as presenter to delegate the response object.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Analytics</span></span></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">ResponsePresenters</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Base</span></span></span><br><span class="line">      <span class="keyword">attr_reader</span> <span class="symbol">:object</span>, <span class="symbol">:raw</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(object)</span></span></span><br><span class="line">        <span class="variable">@object</span> = JSON.parse(object)</span><br><span class="line">        <span class="variable">@raw</span>    = object</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">as_json</span><span class="params">(*)</span></span></span><br><span class="line">        ...</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      private</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line">      ...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">OtherPresenter</span> &lt; Base</span></span><br><span class="line">      ...</span><br><span class="line">      ...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><code>as_json</code> allows the object in <code>render json:</code> to be automatically called and transform to JSON string. It’s an example of <code>Liskov Subsitution Principle</code> or Duck Typing technique since we want the response-like object to be act like the <code>response</code> resulting from <code>RestClient</code></p>
<p>Let’s look at our refreshed request handler</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Anaylytics</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line">    <span class="keyword">include</span> Singleton</span><br><span class="line"></span><br><span class="line">    BASE_URL = <span class="string">&quot;<span class="subst">#&#123;SERVICES[<span class="string">&#x27;anaylytics&#x27;</span>][<span class="string">&#x27;api_host&#x27;</span>]&#125;</span>&quot;</span>.freeze</span><br><span class="line">    URLS = &#123;</span><br><span class="line">      <span class="symbol">top_sale:</span> <span class="string">&#x27;top_sale&#x27;</span></span><br><span class="line">    &#125;.freeze</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> &lt;&lt; self</span></span><br><span class="line">      extend Forwardable</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">method_added</span><span class="params">(method)</span></span></span><br><span class="line">        (<span class="class"><span class="keyword">class</span> &lt;&lt; self;</span> <span class="keyword">self</span>; <span class="keyword">end</span>).def_delegator <span class="symbol">:instance</span>, method</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(key, <span class="symbol">params:</span> &#123;&#125;, <span class="symbol">presenter:</span> Analytics::ResponsePresenters::Base)</span></span></span><br><span class="line">      <span class="comment"># Added ParamsValidator</span></span><br><span class="line">      ParamsValidator.new(params).validate!</span><br><span class="line">      response = RestClient::Request.execute(</span><br><span class="line">        <span class="symbol">method:</span> <span class="symbol">:get</span>,</span><br><span class="line">        <span class="symbol">url:</span> <span class="string">&quot;<span class="subst">#&#123;BASE_URL&#125;</span>/<span class="subst">#&#123;URLS[key]&#125;</span>&quot;</span>,</span><br><span class="line">        <span class="symbol">headers:</span> &#123; <span class="symbol">params:</span> params &#125;</span><br><span class="line">      )</span><br><span class="line">      <span class="comment"># Dependencies inject</span></span><br><span class="line">      presenter.new(response)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Since we do not need all the presenters at once, and probably only need to present/decorate the response at each request. The <code>Open/Close Principle</code> is quite suitable here which gives us the idea to inject the module class we want.</p>
<p>Finally, our end result controller action will be like</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="keyword">include</span> Analytics::Request::ErrorsHandler</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">top_sale</span></span></span><br><span class="line">  response = Anaylytics::Request.get(<span class="symbol">:top_sale</span>, <span class="symbol">params:</span> &#123;</span><br><span class="line">    <span class="symbol">merchant_id:</span> current_merchant.id,</span><br><span class="line">    <span class="symbol">start_date:</span> analytics_params[<span class="symbol">:start_date</span>],</span><br><span class="line">    <span class="symbol">end_date:</span> analytics_params[<span class="symbol">:end_date</span>]</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  render <span class="symbol">json:</span> response, <span class="symbol">status:</span> response.code</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>I think this example demestrate some of the SOLID principles and design patterns we can use in daily basis. Thanks for reading!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://berniechiu.github.io/blog/posts/1db9426/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Bernie Chiu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BC Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/posts/1db9426/" class="post-title-link" itemprop="url">Airflow on Kubernetes Part I</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-17 08:47:24" itemprop="dateCreated datePublished" datetime="2018-08-17T08:47:24+08:00">2018-08-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-10-14 12:02:22" itemprop="dateModified" datetime="2018-10-14T12:02:22+08:00">2018-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Building an industrial design on Kubernetes is hard, but building on top of pre-existed application without support is even harder.</p>
<p>I found two repos are quite suitable for such cases</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mumoshu/kube-airflow">Docker Airflow</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/mumoshu/kube-airflow">Kube Airflow</a></p>
<p>Due to the fact that Kube Airflow expects Helm chart supports for K8S in mind and less actively maintain, and later I found <a target="_blank" rel="noopener" href="https://github.com/helm/charts/issues/2591">https://github.com/helm/charts/issues/2591</a> has already started an official support for the Airflow. Therfore, I decided to use simplified Docker Airflow image for deployment for now if Airflow chart is still at its early stage.</p>
<p>Even so, a simple Docker Airflow could cause you nightmares too. That’s why I guessed many people have forked their own versions. The Python dependencies are not specifically locked into the <code>Dockerfile</code>, so basically when building an image will install the latest version first which might crash Airflow application. I suggest to lock the specific version to make sure every developers will consume the same environments on their own machines. Of course, that’s what Docker meant for, isn’t it?</p>
<p>Since we’re deploying on Kubernetes which is already a great support for microservices on <code>Pods</code> and <code>Containers</code> distributions, keeping <code>LocalExecutioner</code> for <code>docker-compose</code> won’t reflect too much on our real deployment. Removing the <code>LocalExecutioner</code> for <code>docker-compose</code> is fine and make sure the <code>CeleryExecutioner</code> should work well for the local  development. However, I suggest to have environment variables put into files like <code>.env</code> for better management of keys instead of hardcoded. Later on, we could <code>.gitignore</code> these files and deploy more freely for  different environments setting on machines.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://berniechiu.github.io/blog/posts/add7b875/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Bernie Chiu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BC Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/posts/add7b875/" class="post-title-link" itemprop="url">Switching to puma-dev on New MacOS</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-04-22 12:47:58" itemprop="dateCreated datePublished" datetime="2018-04-22T12:47:58+08:00">2018-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-10-14 12:02:22" itemprop="dateModified" datetime="2018-10-14T12:02:22+08:00">2018-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Since I’m getting a new Mac recently, I have realized that <a target="_blank" rel="noopener" href="http://pow.cx/manual.html#section_6">pow</a> is no longer being maitained and lack of several features like SSL support and WebSockets. I think it’s time to switch for a better alternative at this time being.</p>
<h2 id="Getting-Puma-Dev-on-MacOS"><a href="#Getting-Puma-Dev-on-MacOS" class="headerlink" title="Getting Puma-Dev on MacOS"></a>Getting Puma-Dev on MacOS</h2><h3 id="Install-Puma-Dev"><a href="#Install-Puma-Dev" class="headerlink" title="Install Puma-Dev"></a>Install Puma-Dev</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install puma/puma/puma-dev</span><br></pre></td></tr></table></figure>

<h3 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo puma-dev -setup</span><br></pre></td></tr></table></figure>

<h3 id="Link-Puma-Dev-Application"><a href="#Link-Puma-Dev-Application" class="headerlink" title="Link Puma-Dev Application"></a>Link Puma-Dev Application</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /your/app/path</span><br><span class="line">$ puma-dev link</span><br></pre></td></tr></table></figure>

<h3 id="Start-Puma-Dev-Server"><a href="#Start-Puma-Dev-Server" class="headerlink" title="Start Puma-Dev Server"></a>Start Puma-Dev Server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ puma-dev -d localhost</span><br><span class="line"></span><br><span class="line"><span class="comment">#=&gt; * Directory for apps: /Users/user/.puma-dev</span></span><br><span class="line"><span class="comment">#=&gt; * Domains: localhost</span></span><br><span class="line"><span class="comment">#=&gt; * DNS Server port: 9253</span></span><br><span class="line"><span class="comment">#=&gt; * HTTP Server port: 9280</span></span><br><span class="line"><span class="comment">#=&gt; * HTTPS Server port: 9283</span></span><br></pre></td></tr></table></figure>

<p>Note: <a target="_blank" rel="noopener" href="https://ma.ttias.be/chrome-force-dev-domains-https-via-preloaded-hsts/">Why using default .dev is an issue</a></p>
<h3 id="SSL-Certificate-Issue"><a href="#SSL-Certificate-Issue" class="headerlink" title="SSL Certificate Issue"></a>SSL Certificate Issue</h3><p>If you encounter SSL issue in browers, add the trusted cert in your MacOS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">security add-trusted-cert -k login.keychain-db ~/Library/Application\ Support/io.puma.dev/cert.pem</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://berniechiu.github.io/blog/posts/465cb43f/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Bernie Chiu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BC Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/posts/465cb43f/" class="post-title-link" itemprop="url">Installing PostgresDB on Mac</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-01-31 20:39:27" itemprop="dateCreated datePublished" datetime="2016-01-31T20:39:27+08:00">2016-01-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-10-14 12:02:22" itemprop="dateModified" datetime="2018-10-14T12:02:22+08:00">2018-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Open-a-Termianl"><a href="#Open-a-Termianl" class="headerlink" title="Open a Termianl"></a>Open a Termianl</h3><p>As a developer, you either user <a target="_blank" rel="noopener" href="https://www.iterm2.com/">iTerm2</a> or built-in Terminal very often. Both of them are fine.</p>
<h3 id="Install-Homebrew"><a href="#Install-Homebrew" class="headerlink" title="Install Homebrew"></a>Install Homebrew</h3><p><a target="_blank" rel="noopener" href="http://brew.sh/">Homebrew</a><br>We’ll will start installing Postgres through homebrew, which is a package manager for OSX. Just follow the steps on the official website.</p>
<h3 id="Brew-Install-Postgres"><a href="#Brew-Install-Postgres" class="headerlink" title="Brew Install Postgres"></a>Brew Install Postgres</h3><p>Enter <code>brew install postgres</code> to tell brew to install PostgreSQL for you. You’ll see messages to tell you start the postgres now, but I suggest to manage our background progress in another way.</p>
<h3 id="Install-LaunchRocket"><a href="#Install-LaunchRocket" class="headerlink" title="Install LaunchRocket"></a>Install LaunchRocket</h3><p><img src="/blog/images/launch-rocket-sample-image.png" alt="lauch-rocket-sample-image.png"></p>
<p>I believe <a target="_blank" rel="noopener" href="https://github.com/jimbojsb/launchrocket">LaunchRocket</a> is great for managing brew-installed services, all you need to do is to click start and the service will be up. Becuase I use my personal laptop for many things, I don’t want most of the service to run automatically at startup to eat up my memory. Therefore, this is a great tool to work with.</p>
<h3 id="Create-a-Default-DB-Based-on-Your-Username"><a href="#Create-a-Default-DB-Based-on-Your-Username" class="headerlink" title="Create a Default DB Based on Your Username"></a>Create a Default DB Based on Your Username</h3><p>Since Postgres use the username as a default DB entrance. Type <code>createdb &#39;whoami&#39;</code> in your terminal to make sure you can have a database to enter and test.</p>
<h3 id="Try-Out-the-psql-Command"><a href="#Try-Out-the-psql-Command" class="headerlink" title="Try Out the psql Command"></a>Try Out the psql Command</h3><p>Try out <code>psql</code> in the terminal. If you enter the command-line interface to PostgreSQL, then you’re good to go!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://berniechiu.github.io/blog/posts/d299683d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Bernie Chiu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BC Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/posts/d299683d/" class="post-title-link" itemprop="url">Play Around with Chef Install on New EC2 Instance</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-12-10 20:28:51" itemprop="dateCreated datePublished" datetime="2015-12-10T20:28:51+08:00">2015-12-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-10-14 12:02:22" itemprop="dateModified" datetime="2018-10-14T12:02:22+08:00">2018-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="GitHub-Connection-Issues"><a href="#GitHub-Connection-Issues" class="headerlink" title="GitHub Connection Issues"></a>GitHub Connection Issues</h4><p>Not sure why server’s SSH connection use the different algoritems for GitHub connection</p>
<p>References:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.openssh.com/legacy.html">http://www.openssh.com/legacy.html</a></li>
<li><a target="_blank" rel="noopener" href="https://stribika.github.io/2015/01/04/secure-secure-shell.html">https://stribika.github.io/2015/01/04/secure-secure-shell.html</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.github.com/guides/using-ssh-agent-forwarding">https://developer.github.com/guides/using-ssh-agent-forwarding</a></li>
</ul>
<p>How to Resolve:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ~/.ssh/config Add here</span></span><br><span class="line"></span><br><span class="line">Host github.com</span><br><span class="line">    KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256,diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1</span><br><span class="line"></span><br><span class="line">Host *</span><br><span class="line">    KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256</span><br></pre></td></tr></table></figure>

<h4 id="MySQL-Database-Socket-Path-is-not-Default-to-tmp-mysql-sock"><a href="#MySQL-Database-Socket-Path-is-not-Default-to-tmp-mysql-sock" class="headerlink" title="MySQL Database Socket Path is not Default to /tmp/mysql.sock"></a>MySQL Database Socket Path is not Default to <code>/tmp/mysql.sock</code></h4><p>How to Resolve:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysqladmin variables -u root -p | grep sock</span><br></pre></td></tr></table></figure>

<h4 id="MySQL-Securities"><a href="#MySQL-Securities" class="headerlink" title="MySQL Securities"></a>MySQL Securities</h4><p>Since MySQL default to root users, we should provide different roles for specific authorizations</p>
<p>By preventing application to access root auth, less impact will be caused by database being compromised</p>
<h4 id="Colorful-Terminal"><a href="#Colorful-Terminal" class="headerlink" title="Colorful Terminal"></a>Colorful Terminal</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># touch ~/.bash_aliases</span></span><br><span class="line">PS1=<span class="string">&#x27;\[\033[1;33m\]\u\[\033[1;37m\]@\[\033[1;32m\]\h\[\033[1;37m\]:\[\033[1;31m\]\w\[\033[1;36m\]\$ \[\033[0m\]&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="NGINX-Always-Showing-the-Default-Page"><a href="#NGINX-Always-Showing-the-Default-Page" class="headerlink" title="NGINX Always Showing the Default Page"></a>NGINX Always Showing the Default Page</h4><p>How to Resolve:</p>
<p><code>cd etc/nginx/sites-available</code> delete <code>default</code> file</p>
<p><code>sudo vi etc/nginx/nginx.conf</code> delete <code>include</code> command under  <code>default</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://berniechiu.github.io/blog/posts/751b5e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Bernie Chiu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BC Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/posts/751b5e/" class="post-title-link" itemprop="url">Building Robust API Client with Her Gem</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-09-28 20:26:28" itemprop="dateCreated datePublished" datetime="2015-09-28T20:26:28+08:00">2015-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-10-14 12:02:22" itemprop="dateModified" datetime="2018-10-14T12:02:22+08:00">2018-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>The topic sounds a little awkward, but there’s really a gem called <code>Her</code></p>
<p>Here’s the official documentation<br><a target="_blank" rel="noopener" href="http://www.her-rb.org/">http://www.her-rb.org/</a></p>
<h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><p>In your Gemfile, add</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gem <span class="string">&quot;her&quot;</span></span><br><span class="line">gem <span class="string">&quot;faraday&quot;</span>, <span class="string">&quot;~&gt; 0.8.10&quot;</span></span><br></pre></td></tr></table></figure>

<p>I specified the <code>faraday</code> version to be locked at <code>~&gt; 0.8.10</code> because there’s something wrong the the newest version so far.</p>
<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config/initializers/her.rb</span></span><br><span class="line">Her::API.setup <span class="symbol">url:</span> <span class="string">&quot;https://api.example.com&quot;</span> <span class="keyword">do</span> <span class="params">|c|</span></span><br><span class="line">  <span class="comment"># Request</span></span><br><span class="line">  c.use Faraday::Request::UrlEncoded</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Response</span></span><br><span class="line">  c.use Her::Middleware::DefaultParseJSON</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Adapter</span></span><br><span class="line">  c.use Faraday::Adapter::NetHttp</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>And then to add the ORM behavior to a class, you just have to include <code>Her::Model</code> in it:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line">  <span class="keyword">include</span> Her::Model</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>After that, using Her is very similar to ActiveRecord:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">User.all</span><br><span class="line"><span class="comment"># GET &quot;https://api.example.com/users&quot; and return an array of User objects</span></span><br><span class="line"></span><br><span class="line">User.find(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># GET &quot;https://api.example.com/users/1&quot; and return a User object</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@user</span> = User.create(<span class="symbol">fullname:</span> <span class="string">&quot;Tobias Fünke&quot;</span>)</span><br><span class="line"><span class="comment"># POST &quot;https://api.example.com/users&quot; with `fullname=Tobias+Fünke` and return the saved User object</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@user</span> = User.new(<span class="symbol">fullname:</span> <span class="string">&quot;Tobias Fünke&quot;</span>)</span><br><span class="line"><span class="variable">@user</span>.occupation = <span class="string">&quot;actor&quot;</span></span><br><span class="line"><span class="variable">@user</span>.save</span><br><span class="line"><span class="comment"># POST &quot;https://api.example.com/users&quot; with `fullname=Tobias+Fünke&amp;occupation=actor` and return the saved User object</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@user</span> = User.find(<span class="number">1</span>)</span><br><span class="line"><span class="variable">@user</span>.fullname = <span class="string">&quot;Lindsay Fünke&quot;</span></span><br><span class="line"><span class="variable">@user</span>.save</span><br><span class="line"><span class="comment"># PUT &quot;https://api.example.com/users/1&quot; with `fullname=Lindsay+Fünke` and return the updated User object</span></span><br></pre></td></tr></table></figure>

<h3 id="Customization"><a href="#Customization" class="headerlink" title="Customization"></a>Customization</h3><p>For custom primary key:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  primary_key <span class="symbol">:user_id</span> <span class="comment"># use user_id instead of id</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>For custom collection path:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  collection_path <span class="string">&quot;user_all&quot;</span> <span class="comment"># &quot;/user_all&quot; instead of &quot;/users&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>For custom association:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line">  has_many <span class="symbol">:comments</span>, <span class="symbol">data_key:</span> <span class="string">&quot;comment_items&quot;</span>, <span class="symbol">path:</span> <span class="string">&quot;comment_items&quot;</span></span><br><span class="line">  <span class="comment"># &quot;data key&quot; represents the attribute in the user collection JSON for comments</span></span><br><span class="line">  <span class="comment"># &quot;path&quot; specifies the route for the resource ex.&quot;/users/:id/comment_items&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://berniechiu.github.io/blog/posts/398c98be/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Bernie Chiu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BC Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/posts/398c98be/" class="post-title-link" itemprop="url">Tips for Image Migration to AWS S3</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-05-25 20:17:43" itemprop="dateCreated datePublished" datetime="2015-05-25T20:17:43+08:00">2015-05-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-10-14 12:02:22" itemprop="dateModified" datetime="2018-10-14T12:02:22+08:00">2018-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Objectives"><a href="#Objectives" class="headerlink" title="Objectives"></a>Objectives</h2><p>When migrating to S3, there comes a time that you finished uploading your server images, but users continue to upload afterwards.</p>
<p>This is an issue for us because we don’t want to use <a target="_blank" rel="noopener" href="https://github.com/AssetSync/asset_sync">Asset Sync</a> all the time since it might slow down the server power because it replaces them with all the files.</p>
<p>A rake script might come to our rescue while we only need to run a check for server files creation timestamp and then just upload the file we need to reduce the overall syncing process of amazon command line tool.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;pry&quot;</span></span><br><span class="line"></span><br><span class="line">namespace <span class="symbol">:s3</span> <span class="keyword">do</span></span><br><span class="line">  desc <span class="string">&quot;Upload recent local images to S3 (A rake helper while migrating to S3, no use after S3 completed migration)&quot;</span></span><br><span class="line">  task <span class="symbol">upload:</span> <span class="symbol">:environment</span> <span class="keyword">do</span></span><br><span class="line">    local_path = <span class="string">&quot;/home/apps/my-project/shared/public/system&quot;</span></span><br><span class="line">    s3_path = Rails.env.staging? ? <span class="string">&quot;/my-project-staging/system&quot;</span> : <span class="string">&quot;/my-project/system&quot;</span></span><br><span class="line"></span><br><span class="line">    image_folder_ids = Dir::glob(<span class="string">&quot;<span class="subst">#&#123;local_path&#125;</span>/images/*/&quot;</span>).find_all &#123; <span class="params">|f|</span> File.mtime(f) &gt;= <span class="number">5</span>.days.ago &#125;</span><br><span class="line">    excerpt_image_folder_ids = Dir::glob(<span class="string">&quot;<span class="subst">#&#123;local_path&#125;</span>/excerpt_images/*/&quot;</span>).find_all &#123; <span class="params">|f|</span> File.mtime(f) &gt;= <span class="number">5</span>.days.ago &#125;</span><br><span class="line">    headline_image_folder_ids = Dir::glob(<span class="string">&quot;<span class="subst">#&#123;local_path&#125;</span>/headline_images/*/&quot;</span>).find_all &#123; <span class="params">|f|</span> File.mtime(f) &gt;= <span class="number">5</span>.days.ago &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> image_folder_ids.present?</span><br><span class="line">      puts <span class="string">&quot;Image IDs Updated 5 days ago&quot;</span></span><br><span class="line">      puts <span class="string">&quot;-----------------------------&quot;</span></span><br><span class="line">      puts image_folder_ids</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> excerpt_image_folder_ids.present?</span><br><span class="line">      puts <span class="string">&quot;Excerpt Image IDs Updated 5 days ago&quot;</span></span><br><span class="line">      puts <span class="string">&quot;-----------------------------&quot;</span></span><br><span class="line">      puts excerpt_image_folder_ids</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> headline_image_folder_ids.present?</span><br><span class="line">      puts <span class="string">&quot;Headline Image IDs Updated 5 days ago&quot;</span></span><br><span class="line">      puts <span class="string">&quot;-----------------------------&quot;</span></span><br><span class="line">      puts headline_image_folder_ids</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    puts <span class="string">&quot;\nUploading...\n&quot;</span></span><br><span class="line"></span><br><span class="line">    image_folder_ids.each <span class="keyword">do</span> <span class="params">|folder_path|</span></span><br><span class="line">      id = File.split(folder_path).last</span><br><span class="line">      cmd = <span class="string">&quot;s3cmd put -P <span class="subst">#&#123;folder_path&#125;</span> s3:/<span class="subst">#&#123;s3_path&#125;</span>/images/<span class="subst">#&#123;id&#125;</span>/ --recursive&quot;</span></span><br><span class="line">      puts cmd</span><br><span class="line">      <span class="string">%x(<span class="subst">#&#123;cmd&#125;</span>)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    excerpt_image_folder_ids.each <span class="keyword">do</span> <span class="params">|folder_path|</span></span><br><span class="line">      id = File.split(folder_path).last</span><br><span class="line">      cmd = <span class="string">&quot;s3cmd put -P <span class="subst">#&#123;folder_path&#125;</span> s3:/<span class="subst">#&#123;s3_path&#125;</span>/excerpt_images/<span class="subst">#&#123;id&#125;</span>/ --recursive&quot;</span></span><br><span class="line">      puts cmd</span><br><span class="line">      <span class="string">%x(<span class="subst">#&#123;cmd&#125;</span>)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    headline_image_folder_ids.each <span class="keyword">do</span> <span class="params">|folder_path|</span></span><br><span class="line">      id = File.split(folder_path).last</span><br><span class="line">      cmd = <span class="string">&quot;s3cmd put -P <span class="subst">#&#123;folder_path&#125;</span> s3:/<span class="subst">#&#123;s3_path&#125;</span>/headline_images/<span class="subst">#&#123;id&#125;</span>/ --recursive&quot;</span></span><br><span class="line">      puts cmd</span><br><span class="line">      <span class="string">%x(<span class="subst">#&#123;cmd&#125;</span>)</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    puts <span class="string">&quot;Finished!&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://berniechiu.github.io/blog/posts/b541a315/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="Bernie Chiu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BC Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blog/posts/b541a315/" class="post-title-link" itemprop="url">Tips for Improve SQL Query Performance in Rails Using Counter Cache</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2014-04-03 20:06:44" itemprop="dateCreated datePublished" datetime="2014-04-03T20:06:44+08:00">2014-04-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-10-14 12:02:22" itemprop="dateModified" datetime="2018-10-14T12:02:22+08:00">2018-10-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>I recently discovered that <strong>COUNTER CACHE</strong> is a great way to improve some SQL query performance across relational tables.</p>
<p>Since I have  <strong>TOP LINKS</strong> showing on my <strong>SIMPLE REDDIT</strong> web app, I encountered some issues to scale the top links performance with Rails. Later, I found that counter cache might be the solution</p>
<h3 id="Here’s-what-my-implementation-in-pages-controller-rb-looks-like"><a href="#Here’s-what-my-implementation-in-pages-controller-rb-looks-like" class="headerlink" title="Here’s what my implementation in pages_controller.rb looks like"></a>Here’s what my implementation in <code>pages_controller.rb</code> looks like</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@popular_links</span> = Link.includes(<span class="symbol">:category</span>, <span class="symbol">:votes</span>).top</span><br></pre></td></tr></table></figure>

<p>I originally designed the vote model seperately which contains “up” vote and “down” vote attributes.</p>
<h3 id="Relate-Link-Model-to-fake-votes-attributes-using-class-name"><a href="#Relate-Link-Model-to-fake-votes-attributes-using-class-name" class="headerlink" title="Relate Link Model to fake votes attributes using class_name"></a>Relate Link Model to fake votes attributes using <code>class_name</code></h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">has_many <span class="symbol">:up_votes</span>, <span class="symbol">class_name:</span> <span class="string">&#x27;Vote&#x27;</span>, <span class="symbol">conditions:</span> &#123; <span class="symbol">up:</span> <span class="literal">true</span> &#125;</span><br><span class="line">has_many <span class="symbol">:down_votes</span>, <span class="symbol">class_name:</span> <span class="string">&#x27;Vote&#x27;</span>, <span class="symbol">conditions:</span> &#123; <span class="symbol">up:</span> <span class="literal">false</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Compare-the-value-from-highest-to-lowest"><a href="#Compare-the-value-from-highest-to-lowest" class="headerlink" title="Compare the value from highest to lowest"></a>Compare the value from highest to lowest</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def <span class="keyword">self</span>.top</span><br><span class="line">  <span class="keyword">self</span>.all.sort <span class="keyword">do</span> <span class="params">|a, b|</span></span><br><span class="line">    (b.up_votes.length - b.down_votes.length) &lt;=&gt;</span><br><span class="line">    (a.up_votes.length - a.down_votes.length)</span><br><span class="line">  <span class="keyword">end</span>.first(<span class="number">6</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>The query at this stage is quite slow because it always takes up to 200ms to complete the page before counter cache is implemented. Therefore, I followed along with the <a target="_blank" rel="noopener" href="http://railscasts.com/episodes/23-counter-cache-column">RailsCasts</a> tutorial and tried to modify some of my code.</p>
<h3 id="Add-migration-to-up-and-down-votes-count"><a href="#Add-migration-to-up-and-down-votes-count" class="headerlink" title="Add migration to up and down votes count"></a>Add migration to up and down votes count</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add_column <span class="symbol">:links</span>, <span class="symbol">:up_votes_count</span>, <span class="symbol">:integer</span>, <span class="symbol">default:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Link.reset_column_information</span><br><span class="line">Link.all.each <span class="keyword">do</span> <span class="params">|link|</span></span><br><span class="line">  link.update_attribute <span class="symbol">:up_votes_count</span>, link.up_votes.length</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>And do the same to down votes.</p>
<h3 id="Specify-the-cache-column-to-Vote-Model"><a href="#Specify-the-cache-column-to-Vote-Model" class="headerlink" title="Specify the cache column to Vote Model"></a>Specify the cache column to Vote Model</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">belongs_to <span class="symbol">:link</span>, <span class="symbol">counter_cache:</span> <span class="symbol">:up_votes_count</span></span><br><span class="line">belongs_to <span class="symbol">:link</span>, <span class="symbol">counter_cache:</span> <span class="symbol">:down_votes_count</span></span><br></pre></td></tr></table></figure>

<p>Seems easy enough! Now I have my page completed under 30ms most of the time and I won’t see lots of query showing up on my log screen. Anyway, I believe this is a great way for me to solve problems like this in the future.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><a class="page-number" href="/blog/page/3/">3</a><a class="extend next" rel="next" href="/blog/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Bernie Chiu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/berniechiu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;berniechiu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/berniechewy" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;berniechewy" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bernie Chiu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  















  

  

</body>
</html>
